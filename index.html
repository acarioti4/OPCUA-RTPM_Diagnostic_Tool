<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPCUA-RTPM Diagnostic Tool</title>
  <style>
    :root {
      --container-bg: #ffffff;
      --text-primary: #333333;
      --text-muted: #666666;
      --results-bg: #f8f9fa;
      --log-bg: #e7f3ff;
      --log-border: #2196F3;
      --accent: #667eea; /* single solid accent */
      --bg: #f3f4f6;     /* single solid background */
      --shadow-accent: rgba(102, 126, 234, 0.35); /* glow color */
      /* Glass + background defaults */
      --bg-image: none;
      --accent-2: #7ea2ff;
      --glass-bg: rgba(255,255,255,0.45);
      --glass-stroke: rgba(0,0,0,0.06);
      --glass-shadow: rgba(0, 0, 0, 0.30);
      --overlay-scrim: rgba(255,255,255,0.06);
    }

    /* Light theme */
    .theme-light {
      --container-bg: #ffffff;
      --text-primary: #111827; /* slate-900 */
      --text-muted: #6b7280;   /* slate-500 */
      --results-bg: #f9fafb;   /* slate-50 */
      --log-bg: #eef6ff;       /* subtle info */
      --log-border: #93c5fd;   /* blue-300 */
      --accent: #ec4899;       /* sakura pink */
      --accent-2: #f472b6;     /* lighter pink */
      --bg: #f3f4f6;           /* app background */
      --shadow-accent: rgba(37, 99, 235, 0.25);
      --keyline: rgba(0,0,0,0.06);
      --header-bg: linear-gradient(180deg, rgba(255,255,255,0.75) 0%, rgba(255,255,255,0.55) 100%);
      --bg-image: url('assets/light-sakura.svg');
      --glass-bg: rgba(255,255,255,0.52);
      --glass-stroke: rgba(255,255,255,0.65);
      --overlay-scrim: rgba(255,255,255,0.10);
    }

    /* Dark theme */
    .theme-dark {
      --container-bg: #1a1b1f; /* graphite armor */
      --text-primary: #e5e7eb; /* imperial light */
      --text-muted: #9ca3af;   /* muted steel */
      --results-bg: #111215;   /* cockpit black */
      --log-bg: #0d0e11;       /* deeper black */
      --log-border: #ef4444;   /* sith red accent */
      --accent: #8b5cf6;       /* indigo for night */
      --accent-2: #60a5fa;     /* blue highlight */
      --bg: #0a0b0d;           /* void black */
      --shadow-accent: rgba(185, 28, 28, 0.35);
      --keyline: rgba(255,255,255,0.08);
      --header-bg: linear-gradient(180deg, rgba(17,18,21,0.75) 0%, rgba(10,11,13,0.65) 100%);
      --bg-image: url('assets/dark-starry.svg');
      --glass-bg: rgba(14,15,20,0.54);
      --glass-stroke: rgba(255,255,255,0.08);
      --overlay-scrim: rgba(0,0,0,0.35);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      padding: 20px;
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Thematic high-res background + scrim for readability */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -2;
      will-change: transform;
      transform: translateZ(0);
    }
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(1200px 800px at 50% 15%, rgba(255,255,255,0.12), transparent 50%),
        linear-gradient(180deg, var(--overlay-scrim) 0%, rgba(0,0,0,0.0) 60%, rgba(0,0,0,0.25) 100%);
      pointer-events: none;
    }

    /* removed gradient animations to keep solid tones */

    .container {
      max-width: 850px;
      margin: 0 auto;
      background: var(--glass-bg);
      border-radius: 16px;
      box-shadow: 0 30px 80px var(--glass-shadow);
      border: 1px solid var(--glass-stroke);
      -webkit-backdrop-filter: saturate(160%) blur(20px);
      backdrop-filter: saturate(160%) blur(20px);
      overflow: hidden;
      position: relative;
    }


    .header {
      background: var(--header-bg);
      color: var(--text-primary);
      padding: 30px;
      text-align: center;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      border-bottom: 1px solid var(--glass-stroke);
    }
    body.theme-dark .header { color: var(--text-primary); }


    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;

    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    /* Ensure title/subtitle remain readable across gradients */
    .header h1, .header p {
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }


    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--keyline);
      margin-bottom: 16px;
    }
    .tab-button {
      appearance: none;
      border: 0;
      background: transparent;
      color: var(--text-muted);
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .tab-button.active {
      color: var(--text-primary);
      background: var(--container-bg);
      box-shadow: 0 -2px 0 0 var(--accent) inset, 0 4px 14px rgba(0,0,0,0.06);
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    .theme-chip {
      border: none;
      border-radius: 9999px;
      padding: 6px 12px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      background: rgba(255,255,255,0.5);
      -webkit-backdrop-filter: saturate(160%) blur(12px);
      backdrop-filter: saturate(160%) blur(12px);
      color: var(--text-primary);
      border: 1px solid var(--glass-stroke);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }


    .theme-chip:hover {
      transform: translateY(-1px);
    }

    .theme-chip.light.active {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.8) inset, 0 6px 20px var(--shadow-accent);
    }

    .theme-chip.dark.active {
      background: var(--accent);
      color: #e5e7eb;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.5) inset, 0 6px 20px rgba(0,0,0,0.35);
    }

    .content {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--glass-stroke);
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
      background: rgba(255,255,255,0.85);
      -webkit-backdrop-filter: saturate(150%) blur(8px);
      backdrop-filter: saturate(150%) blur(8px);
      color: var(--text-primary);
      caret-color: var(--accent);
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.22);
    }
    input::placeholder { color: rgba(17,24,39,0.5); }
    .btn:focus-visible, .theme-chip:focus-visible, input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    body.theme-dark input {
      border-color: rgba(255,255,255,0.14);
      background: #0f1117;
      color: var(--text-primary);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    body.theme-dark input::placeholder { color: rgba(229,231,235,0.48); }
    body.theme-dark input:focus { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.28); }

    .port-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18), 0 0 0 1px rgba(255,255,255,0.1) inset;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.0) 40%);
      mix-blend-mode: soft-light;
      pointer-events: none;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-accent), 0 0 18px var(--shadow-accent);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Determinate progress (0â€“100%) shown below the button */
    .run-progress {
      margin-top: 16px;
      display: none;
    }
    .progress-outer {
      height: 18px;
      background: rgba(255,255,255,0.25);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--glass-stroke);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.15), 0 8px 20px rgba(0,0,0,0.15);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
      box-shadow: 0 0 24px var(--shadow-accent);
      transition: width 300ms ease;
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .current-task {
      display: none;
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-primary);
    }
    /* Jedi theme: subtle glow on the gradient split already added above */

    /* Button morphs into an inline progress bar while running */
    .btn.progressing {
      position: relative;
      transform: none !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.15);
      color: transparent; /* hide label while progress is shown */
    }
    .btn.progressing:hover {
      transform: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }
    .inline-progress {
      height: 10px;
      width: 100%;
      background: rgba(255,255,255,0.28);
      border-radius: 9999px;
      overflow: hidden;
    }
    .inline-progress .bar {
      position: relative;
      height: 100%;
      width: 40%;
      left: -40%;
      border-radius: 9999px;
      background: linear-gradient(90deg, #ffffff, rgba(255,255,255,0.75));
      box-shadow: 0 0 14px var(--shadow-accent);
      animation: indeterminateSweep 1.2s ease-in-out infinite;
    }
    @keyframes indeterminateSweep {
      0%   { left: -40%; width: 40%; }
      50%  { left: 20%;  width: 60%; }
      100% { left: 100%; width: 40%; }
    }

    .results-section {
      margin-top: 30px;
      display: none;
    }

    .results-section.active {
      display: block;
    }

    .results-list {
      background: rgba(255,255,255,0.45);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--glass-stroke);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12) inset;
    }
    .category-title {
      margin: 14px 0 8px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-top: 1px solid var(--keyline);
      padding-top: 10px;
    }

    .result-item {
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      border-left: 4px solid;
      background: rgba(255,255,255,0.6);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border: 1px solid var(--glass-stroke);
      animation: fadeSlideIn 300ms ease-out;
    }


    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.12);
      border-top-color: var(--accent);
      border-radius: 50%;
      display: inline-block;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: text-bottom;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.001ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.001ms !important;
        scroll-behavior: auto !important;
      }
    }

    .result-item.open { border-left-color: #28a745; }
    .result-item.closed { border-left-color: #dc3545; }
    .result-item.timeout { border-left-color: #ffc107; }
    .result-item.warning { border-left-color: #ffc107; }

    .result-item strong {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .result-item span {
      font-size: 13px;
      color: #666;
    }

    .result-item.open strong, .result-item.open span { color: #28a745; }
    .result-item.closed strong, .result-item.closed span { color: #dc3545; }
    .result-item.timeout strong, .result-item.timeout span { color: #ffc107; }
    .result-item.warning strong, .result-item.warning span { color: #ffc107; }

    .log-info {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.5);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-stroke);
      border-radius: 12px;
      font-size: 14px;
    }

    .log-info strong {
      display: block;
      margin-bottom: 5px;
      color: var(--accent);
    }

    /* About Modal */
    .about-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }
    .about-overlay.active { display: flex; }
    .about-modal {
      background: var(--glass-bg);
      color: var(--text-primary);
      border-radius: 16px;
      padding: 24px;
      width: min(480px, 90vw);
      box-shadow: 0 16px 40px var(--shadow-accent, rgba(0,0,0,0.35));
      border: 1px solid var(--glass-stroke);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      position: relative;
    }

    .about-title { margin-bottom: 8px; font-size: 18px; font-weight: 800; letter-spacing: 0.3px; }
    .about-body { font-size: 14px; color: var(--text-muted); line-height: 1.5; }
    .about-meta { margin-top: 12px; padding-top: 12px; border-top: 2px dashed rgba(0,0,0,0.08); display: grid; row-gap: 6px; }
    .about-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-muted);
    }
    .about-close:hover { color: var(--text-primary); }

    /* Reduced motion: already handled below */

    /* Backdrop-filter fallback for older GPUs/drivers */
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
      .container,
      .results-list,
      .result-item,
      .about-modal,
      .theme-chip,
      input,
      .progress-outer {
        background: var(--container-bg);
      }
      .btn { filter: saturate(110%); }
      body::after {
        background: linear-gradient(180deg, rgba(255,255,255,0.75) 0%, rgba(255,255,255,0.0) 40%);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>OPCUA-RTPM Diagnostic Tool</h1>
      <p>Connectivity and Callback Path Diagnostics</p>
      <!-- Settings are available in the native menu bar -->
    </div>

    <div class="content">
      <div class="tabs" role="tablist" aria-label="Diagnostics">
        <button class="tab-button active" disabled>Callback Path Probe</button>
      </div>

      <form id="probeForm">
        <div class="form-group">
          <label for="endpointUrl">OPC UA Endpoint URL</label>
          <input
            type="text"
            id="endpointUrl"
            placeholder="e.g., opc.tcp://192.168.1.50:4840"
            value="opc.tcp://127.0.0.1:4840"
            required
          >
        </div>
        <div class="port-range">
          <div class="form-group">
            <label for="systemBHost">System B IP (optional, for SYN filter)</label>
            <input
              type="text"
              id="systemBHost"
              placeholder="e.g., 192.168.1.60"
              pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
            >
          </div>
          <div class="form-group">
            <label for="synSeconds">SYN Monitor Seconds</label>
            <input
              type="number"
              id="synSeconds"
              min="0"
              max="120"
              value="10"
              required
            >
          </div>
        </div>
        <div class="port-range">
          <div class="form-group">
            <label for="nodeId">Monitored NodeId (optional)</label>
            <input
              type="text"
              id="nodeId"
              placeholder="ns=0;i=2258 (ServerStatus_CurrentTime)"
            >
          </div>
          <div class="form-group">
            <label for="pubInterval">Publishing Interval (ms)</label>
            <input
              type="number"
              id="pubInterval"
              min="50"
              max="10000"
              value="250"
              required
            >
          </div>
        </div>
        <button type="submit" class="btn" id="btnRunProbe">Run Callback Path Probe</button>
        <div class="run-progress" id="runProgress" aria-hidden="true">
          <div class="progress-outer" aria-label="Probe progress">
            <div class="progress-inner" id="progressInner"></div>
          </div>
          <div class="progress-meta">
            <span id="progressLabel">Preparingâ€¦</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="current-task" id="currentTaskWrapper">
            <span id="currentTaskText">Ready</span>
          </div>
        </div>
      </form>

      <div class="results-section" id="resultsSection">
        <div class="results-list" id="resultsList"></div>
        <div class="log-info" id="logInfo"></div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="about-overlay" id="aboutOverlay" aria-hidden="true">
    <div class="about-modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
      <button class="about-close" id="aboutClose" aria-label="Close About">&times;</button>
      <div class="about-title" id="aboutTitle">About</div>
      <div class="about-body">
        <div class="about-meta">
          <div><strong>Version:</strong> <span id="aboutVersion">-</span></div>
          <div>2025</div>
        </div>
        <div style="margin-top:10px;">
          <a href="#" id="aboutLink">github.com/acarioti4/OPCUA-RTPM_Diagnostic_Tool</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Keybinds Modal -->
  <div class="about-overlay" id="keybindsOverlay" aria-hidden="true">
    <div class="about-modal" role="dialog" aria-modal="true" aria-labelledby="keybindsTitle">
      <button class="about-close" id="keybindsClose" aria-label="Close Keybinds">&times;</button>
      <div class="about-title" id="keybindsTitle">Keybinds</div>
      <div class="about-body">
        <div class="about-meta">
          <div><strong>Run Probe:</strong> Ctrl+Enter</div>
          <div><strong>Focus Endpoint URL:</strong> Ctrl+L</div>
          <div><strong>Toggle Show Current Task:</strong> Ctrl+T</div>
          <div><strong>Theme - Light:</strong> Ctrl+Alt+L</div>
          <div><strong>Theme - Dark:</strong> Ctrl+Alt+D</div>
          <div><strong>Help - Keybinds:</strong> Ctrl+/</div>
          <div><strong>Help - About:</strong> F1</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const aboutOverlay = document.getElementById('aboutOverlay');
    const aboutClose = document.getElementById('aboutClose');
    const aboutVersion = document.getElementById('aboutVersion');
    const keybindsOverlay = document.getElementById('keybindsOverlay');
    const keybindsClose = document.getElementById('keybindsClose');
    const resultsSection = document.getElementById('resultsSection');
    const resultsList = document.getElementById('resultsList');
    const logInfo = document.getElementById('logInfo');
    const probeForm = document.getElementById('probeForm');
    const btnRunProbe = document.getElementById('btnRunProbe');
    const runProgress = document.getElementById('runProgress');
    const progressInner = document.getElementById('progressInner');
    const progressLabel = document.getElementById('progressLabel');
    const progressPercent = document.getElementById('progressPercent');
    const currentTaskWrapper = document.getElementById('currentTaskWrapper');
    const currentTaskText = document.getElementById('currentTaskText');
    const toggleShowTask = document.getElementById('toggleShowTask');

    // Theme handling (UI toggle removed; default to dark)
    function applyTheme(theme) {
      document.body.classList.remove('theme-light', 'theme-dark');
      if (theme === 'dark') {
        document.body.classList.add('theme-dark');
      } else {
        document.body.classList.add('theme-light');
      }
    }
    // Force default to dark on startup
    const savedTheme = 'dark';
    applyTheme('dark');
    // Sync theme with native menu
    if (window.electronAPI && window.electronAPI.onThemeSet) {
      window.electronAPI.onThemeSet(({ theme } = {}) => {
        if (theme === 'light' || theme === 'dark') {
          applyTheme(theme);
        }
      });
    }
    if (window.electronAPI && window.electronAPI.themeReady) {
      window.electronAPI.themeReady({ theme: savedTheme });
    }

    // Settings: Show Current Task toggle
    const savedShowTask = localStorage.getItem('opcRtpmShowTask') === 'true';
    if (toggleShowTask) {
      toggleShowTask.checked = savedShowTask;
    }
    function applyShowTaskSetting(enabled) {
      localStorage.setItem('opcRtpmShowTask', enabled ? 'true' : 'false');
      currentTaskWrapper.style.display = enabled ? 'block' : 'none';
    }
    applyShowTaskSetting(savedShowTask);
    if (toggleShowTask) {
      toggleShowTask.addEventListener('change', (e) => {
        applyShowTaskSetting(!!e.target.checked);
      });
    }
    // Sync with native menu
    if (window.electronAPI && window.electronAPI.onSettingsSet) {
      window.electronAPI.onSettingsSet(({ showTask } = {}) => {
        applyShowTaskSetting(!!showTask);
      });
    }
    if (window.electronAPI && window.electronAPI.settingsReady) {
      window.electronAPI.settingsReady({ showTask: savedShowTask });
    }

    // Progress helpers
    let progressValue = 0;
    function setProgress(value, label) {
      progressValue = Math.max(0, Math.min(100, Math.floor(value)));
      if (progressInner) progressInner.style.width = progressValue + '%';
      if (progressPercent) progressPercent.textContent = progressValue + '%';
      if (label && progressLabel) progressLabel.textContent = label;
    }
    function setCurrentTask(text) {
      if (currentTaskText) currentTaskText.textContent = text || '';
    }
    function startProgressUI() {
      setProgress(0, 'Startingâ€¦');
      setCurrentTask('Initializing probeâ€¦');
      if (runProgress) {
        runProgress.style.display = 'block';
        runProgress.setAttribute('aria-hidden', 'false');
      }
    }

    // Live progress from backend
    if (window.electronAPI && window.electronAPI.onProbeProgress) {
      window.electronAPI.onProbeProgress(({ percent, label, task }) => {
        if (typeof percent === 'number') setProgress(percent, label);
        if (typeof task === 'string') setCurrentTask(task);
      });
    }

    // About handlers
    function showAbout(version) {
      if (aboutVersion) aboutVersion.textContent = version || '';
      aboutOverlay.classList.add('active');
      aboutOverlay.setAttribute('aria-hidden', 'false');
    }
    function hideAbout() {
      aboutOverlay.classList.remove('active');
      aboutOverlay.setAttribute('aria-hidden', 'true');
    }
    function showKeybinds() {
      keybindsOverlay.classList.add('active');
      keybindsOverlay.setAttribute('aria-hidden', 'false');
    }
    function hideKeybinds() {
      keybindsOverlay.classList.remove('active');
      keybindsOverlay.setAttribute('aria-hidden', 'true');
    }
    if (window.electronAPI && window.electronAPI.onShowAbout) {
      window.electronAPI.onShowAbout(({ version } = {}) => {
        showAbout(version);
      });
    }
    if (window.electronAPI && window.electronAPI.onShowKeybinds) {
      window.electronAPI.onShowKeybinds(() => {
        showKeybinds();
      });
    }
    aboutClose.addEventListener('click', hideAbout);
    const aboutLink = document.getElementById('aboutLink');
    if (aboutLink) {
      aboutLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (window.electronAPI && window.electronAPI.openExternal) {
          window.electronAPI.openExternal('https://github.com/acarioti4/OPCUA-RTPM_Diagnostic_Tool');
        }
      });
    }
    keybindsClose.addEventListener('click', hideKeybinds);
    aboutOverlay.addEventListener('click', (e) => {
      if (e.target === aboutOverlay) hideAbout();
    });
    keybindsOverlay.addEventListener('click', (e) => {
      if (e.target === keybindsOverlay) hideKeybinds();
    });
    document.addEventListener('keydown', (e) => {
      // modal close
      if (e.key === 'Escape' && aboutOverlay.classList.contains('active')) {
        hideAbout();
      }
      if (e.key === 'Escape' && keybindsOverlay.classList.contains('active')) {
        hideKeybinds();
      }
      // Ctrl+Enter => Run Probe
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (!btnRunProbe.disabled) {
          btnRunProbe.click();
        }
      }
      // Ctrl+L => focus endpoint input
      if ((e.ctrlKey || e.metaKey) && (e.key === 'l' || e.key === 'L')) {
        e.preventDefault();
        const ep = document.getElementById('endpointUrl');
        if (ep) ep.focus();
      }
      // Ctrl+/ => open keybinds
      if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        showKeybinds();
      }
      // Theme hotkeys (in addition to native menu accelerators)
      if ((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'l' || e.key === 'L')) {
        e.preventDefault();
        applyTheme('light');
      }
      if ((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'd' || e.key === 'D')) {
        e.preventDefault();
        applyTheme('dark');
      }
    });

    function ensureSection(id, titleText) {
      let header = document.getElementById(id);
      if (!header) {
        header = document.createElement('h4');
        header.className = 'category-title';
        header.id = id;
        header.textContent = titleText;
        resultsList.insertBefore(header, resultsList.firstChild);
      }
      return header;
    }
    function prependItem(sectionHeader, status, title, detail) {
      const item = document.createElement('div');
      item.className = `result-item ${status}`;
      item.innerHTML = `
        <strong>${title}</strong>
        <span>${detail}</span>
      `;
      resultsList.insertBefore(item, sectionHeader.nextSibling);
      resultsSection.classList.add('active');
    }

    probeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      btnRunProbe.disabled = true;

      // show determinate progress bar
      startProgressUI();

      resultsList.innerHTML = '';
      logInfo.textContent = '';
      resultsSection.classList.remove('active');
      try {
        const endpointUrl = document.getElementById('endpointUrl').value.trim();
        const systemBHost = document.getElementById('systemBHost').value.trim();
        const synSeconds = parseInt(document.getElementById('synSeconds').value) || 0;
        const nodeId = document.getElementById('nodeId').value.trim();
        const pubInterval = parseInt(document.getElementById('pubInterval').value) || 250;
        const params = {
          endpointUrl,
          systemBHost: systemBHost || undefined,
          synMonitorSeconds: synSeconds,
          publishIntervalMs: pubInterval
        };
        if (nodeId) params.nodeId = nodeId;

        const res = await window.electronAPI.runOpcuaProbe(params);
        const { probe, logFileName } = res || {};

        if (probe && probe.error) {
          alert('Probe error: ' + probe.error);
        }

        // Endpoint Security
        const secSec = ensureSection('securitySection', 'Endpoint Security');
        if (probe && probe.security) {
          const adv = probe.security.advertisedAnonymous;
          prependItem(secSec, adv ? 'open' : 'closed', 'Anonymous advertised', adv ? 'Yes' : 'No');
          // Negotiated channel (actual connection)
          if (probe.security.negotiatedChannel && (probe.security.negotiatedChannel.securityMode || probe.security.negotiatedChannel.securityPolicyUri)) {
            const ch = probe.security.negotiatedChannel;
            const policy = ch.securityPolicyUri || '(unknown)';
            const extra = (ch.policyShort || ch.classification) ? ` (${[ch.policyShort, ch.classification].filter(Boolean).join('; ')})` : '';
            prependItem(secSec, 'open', 'Negotiated channel', `mode=${ch.securityMode || '(unknown)'} policy=${policy}${extra}`);
            if (ch.serverCertificateSummary) {
              prependItem(secSec, 'open', 'Server certificate', ch.serverCertificateSummary);
            }
          }
          if (probe.security.endpointsQueried && Array.isArray(probe.security.anonymousEndpoints)) {
            if (probe.security.anonymousEndpoints.length) {
              probe.security.anonymousEndpoints.forEach((ed, idx) => {
                prependItem(secSec, 'open', `Anonymous endpoint [${idx + 1}]`, `${ed.endpointUrl} mode=${ed.securityMode} policy=${ed.securityPolicyUri}`);
              });
            }
          }
          // List all discovered endpoints with classification and tokens
          if (probe.security.endpointsQueried && Array.isArray(probe.security.allEndpoints) && probe.security.allEndpoints.length) {
            probe.security.allEndpoints.forEach((ed, idx) => {
              const extra = (ed.policyShort || ed.classification) ? ` (${[ed.policyShort, ed.classification].filter(Boolean).join('; ')})` : '';
              const tokens = Array.isArray(ed.userTokens) && ed.userTokens.length ? `; tokens=${ed.userTokens.join(', ')}` : '';
              prependItem(secSec, 'open', `Endpoint [${idx + 1}]`, `${ed.endpointUrl} mode=${ed.securityMode} policy=${ed.securityPolicyUri}${extra}${tokens}`);
            });
          }
          const anonSess = probe.security.anonymousSession || {};
          if (anonSess.success) {
            prependItem(secSec, 'open', 'Anonymous session', 'Succeeded');
          } else {
            const err = anonSess.error ? String(anonSess.error) : 'Failed';
            prependItem(secSec, 'closed', 'Anonymous session', err);
          }
        } else {
          prependItem(secSec, 'warning', 'Security info', 'Unavailable');
        }

        // Client callback info
        const cbSec = ensureSection('clientInfoSection', 'Client Callback Info');
        if (probe && probe.clientSocket) {
          prependItem(cbSec, 'open', 'Client local socket', `${probe.clientSocket.localAddress}:${probe.clientSocket.localPort}`);
          prependItem(cbSec, 'open', 'Server peer', `${probe.clientSocket.remoteAddress}:${probe.clientSocket.remotePort}`);
        } else {
          prependItem(cbSec, 'warning', 'Client local socket', 'Unavailable');
        }

        // Network interfaces
        const ifSec = ensureSection('interfacesSection', 'System A Network Interfaces');
        if (probe && probe.adapters && probe.adapters.length) {
          probe.adapters.forEach(a => {
            const addrs = (a.addresses || []).map(x => x.address).join(', ');
            prependItem(ifSec, 'open', a.name, addrs || '(no IPv4)');
          });
        } else {
          prependItem(ifSec, 'warning', 'No adapters found', '');
        }

        // Listeners before/after
        const lsSec = ensureSection('listenersSection', 'Process Listening Ports');
        const before = (probe && probe.listenersBefore) || [];
        if (!before.length) {
          prependItem(lsSec, 'warning', 'Before subscription', '(none)');
        } else {
          before.forEach(l => prependItem(lsSec, 'open', 'Before', `${l.localAddress}:${l.localPort} pid=${l.pid}`));
        }
        const after = (probe && probe.listenersAfter) || [];
        if (!after.length) {
          prependItem(lsSec, 'warning', 'After subscription', '(none)');
        } else {
          after.forEach(l => prependItem(lsSec, 'open', 'After', `${l.localAddress}:${l.localPort} pid=${l.pid}`));
        }

        // SYN monitor
        if (probe && probe.synMonitor && probe.synMonitor.enabled) {
          const synSec = ensureSection('synSection', 'Connection Attempt Logger');
          const m = probe.synMonitor.method || 'none';
          if (!probe.synMonitor.events || !probe.synMonitor.events.length) {
            prependItem(synSec, 'warning', `Method: ${m}`, 'No SYN attempts captured');
          } else {
            prependItem(synSec, 'open', `Method: ${m}`, `${probe.synMonitor.events.length} event(s)`);
            probe.synMonitor.events.forEach(ev => {
              prependItem(synSec, 'open', `[${ev.timestamp}]`, `${ev.src}:${ev.srcPort} -> ${ev.dst}:${ev.dstPort} syn=${ev.syn} ack=${ev.ack ? '1' : '0'}`);
            });
          }
        }

        // Log info
        if (res && res.logFileName) {
          logInfo.innerHTML = `
            <strong>ðŸ“„ Probe Log Saved</strong>
            Log file: ${res.logFileName}<br>
            Location: Application logs folder
          `;
        }

      } catch (err) {
        alert('Probe error: ' + (err && err.message ? err.message : String(err)));
        // fallback progress update if backend couldn't report failure
        setProgress(100, 'Failed');
        setCurrentTask('Failed.');
      } finally {
        btnRunProbe.disabled = false;
      }
    });
  </script>
</body>
</html>

